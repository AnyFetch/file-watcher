#!/usr/bin/env node

"use strict";

var fs = require('fs');
var read = require("read");

var sendToAnyFetch = require('../lib/');
var watcher = require('../lib/watcher');
var savePendingFiles = require('../lib/helpers/cursor').savePendingFiles;


if (process.argv.length < 3) {
  console.log("You have to provide a directory");
  process.exit(1);
}

// Is it a directory?
if (!fs.lstatSync(process.argv[2]).isDirectory()) {
  console.log("The directory provided is invalid");
  process.exit(1);
}

var start = function(dir, token) {
  // Check the modifications in the directory at start
  sendToAnyFetch(dir, token, function() {});

  // Watch in real time modifications
  watcher(dir, token);
};

if (!process.argv[3]) {
  read({prompt: 'Token: ', silent: true}, function(err, token) {
    start(process.argv[2], token);
  });
}
else {
  start(process.argv[2], process.argv[3]);
}

process.on('exit', function() {
  savePendingFiles(process.argv[2]);
});
